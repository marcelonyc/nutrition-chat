<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nutrition Chat</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ü•ó</text></svg>" />
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --card: #1f2937;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --accent: #38bdf8;
            --danger: #f87171;
            --mobile-header-h: 48px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at 20% 20%, #12203a, #0b1224 55%);
            color: var(--text);
            height: 100vh;
            height: 100dvh;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .mobile-header {
            display: none;
            background: var(--panel);
            padding: 12px 16px;
            border-bottom: 1px solid #1f2937;
            align-items: center;
            gap: 12px;
        }

        .hamburger {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
        }

        .mobile-brand {
            font-weight: 700;
            letter-spacing: 0.5px;
            flex: 1;
        }

        .sidebar {
            width: 280px;
            background: var(--panel);
            padding: 16px;
            border-right: 1px solid #1f2937;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: transform 0.3s ease;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .brand {
            font-weight: 700;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--card);
            border-radius: 10px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-email {
            font-size: 11px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-logout {
            background: var(--danger);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .btn-logout:hover {
            opacity: 0.8;
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 12px 14px;
            background: var(--accent);
            color: #0b1224;
            font-weight: 600;
            cursor: pointer;
            transition: transform 120ms ease, box-shadow 120ms ease;
            flex-shrink: 0;
        }
        }

        .btn:active {
            transform: translateY(1px);
        }

        .chat-list {
            flex: 1 1 auto;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 0;
            max-height: 60vh;
        }

        .ingredients-section {
            padding-top: 12px;
            border-top: 1px solid #1f2937;
            flex-shrink: 0;
            margin-top: 8px;
        }

        .ingredients-header {
            position: relative;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--muted);
            cursor: help;
            user-select: none;
        }

        .tooltip {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 0.85em;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }

        .tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-content {
            color: var(--text);
        }

        .tooltip-content strong {
            color: var(--primary);
            display: block;
            margin-bottom: 6px;
        }

        .tooltip-content ul {
            margin: 6px 0;
            padding-left: 18px;
        }

        /* Help note styles */
        .help-note {
            position: relative;
            display: flex;
            justify-content: flex-end;
            padding: 8px 16px;
        }

        .help-btn {
            background: var(--card);
            border: 1px solid #293447;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: var(--text);
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 120ms ease;
        }

        .help-btn:hover {
            border-color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
        }

        #help-tooltip {
            left: auto;
            right: 16px;
            max-width: 600px;
        }

        .tooltip-content li {
            margin: 3px 0;
        }

        .ingredients-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn-secondary {
            border: 1px solid #293447;
            border-radius: 10px;
            padding: 10px 12px;
            background: transparent;
            color: var(--text);
            font-weight: 500;
            cursor: pointer;
            transition: all 120ms ease;
            font-size: 13px;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
        }

        .ingredient-count {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
            text-align: center;
        }

        input[type="file"] {
            display: none;
        }

        .ingredients-section {
            padding-top: 12px;
            border-top: 1px solid #1f2937;
            margin-top: 8px;
        }

        .ingredients-header {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--muted);
        }

        .ingredients-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn-secondary {
            border: 1px solid #293447;
            border-radius: 10px;
            padding: 10px 12px;
            background: transparent;
            color: var(--text);
            font-weight: 500;
            cursor: pointer;
            transition: all 120ms ease;
            font-size: 13px;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
        }

        .ingredient-count {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
            text-align: center;
        }

        input[type="file"] {
            display: none;
        }

        .chat-item {
            padding: 12px;
            border-radius: 10px;
            background: var(--card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            border: 1px solid transparent;
        }

        .chat-item.active {
            border-color: var(--accent);
            background: #1b2435;
        }

        .chat-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-actions {
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid #293447;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
        }

        .icon-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .icon-btn.danger:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .messages {
            flex: 1;
            padding: 20px 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bubble {
            max-width: 720px;
            padding: 12px 14px;
            border-radius: 14px;
            line-height: 1.6;
            background: var(--card);
            border: 1px solid #1f2937;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .bubble.user {
            margin-left: auto;
            background: #2b3547;
        }

        .bubble.assistant {
            margin-right: auto;
        }

        .bubble.loading {
            margin-right: auto;
            background: var(--card);
            color: var(--muted);
            font-style: italic;
        }

        .bubble h1,
        .bubble h2,
        .bubble h3,
        .bubble h4,
        .bubble h5,
        .bubble h6 {
            margin: 12px 0 8px 0;
            font-weight: 700;
        }

        .bubble h1 {
            font-size: 1.5em;
        }

        .bubble h2 {
            font-size: 1.3em;
        }

        .bubble h3 {
            font-size: 1.1em;
        }

        .bubble ul,
        .bubble ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .bubble li {
            margin: 4px 0;
        }

        .bubble code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .bubble pre {
            background: #0f172a;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .bubble pre code {
            background: none;
            padding: 0;
            border-radius: 0;
        }

        .bubble blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            margin: 8px 0;
            color: var(--muted);
        }

        .bubble strong {
            font-weight: 700;
        }

        .bubble em {
            font-style: italic;
        }

        .bubble a {
            color: var(--accent);
            text-decoration: none;
        }

        .bubble a:hover {
            text-decoration: underline;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        form {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid #1f2937;
            background: #0c1220;
        }

        footer {
            padding: 8px 20px;
            background: #0c1220;
            border-top: 1px solid #1f2937;
            font-size: 12px;
            color: var(--muted);
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        footer span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        textarea {
            flex: 1;
            border-radius: 12px;
            border: 1px solid #1f2937;
            padding: 12px;
            font-size: 15px;
            background: #0f172a;
            color: var(--text);
            resize: vertical;
            min-height: 60px;
        }

        /* Settings Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--panel);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--muted);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .settings-section {
            margin-bottom: 24px;
            padding: 16px;
            background: var(--card);
            border-radius: 8px;
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .toggle-label {
            font-size: 14px;
            color: var(--text);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--accent);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        .macro-inputs {
            display: none;
            margin-top: 16px;
        }

        .macro-inputs.active {
            display: block;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            background: var(--panel);
            border: 1px solid #374151;
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-hint {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .error-message {
            color: var(--danger);
            font-size: 13px;
            margin-top: 8px;
        }

        .success-message {
            color: var(--accent);
            font-size: 13px;
            margin-top: 8px;
        }

        .btn-settings {
            background: var(--card);
            border: 1px solid #293447;
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 120ms ease;
        }

        .btn-settings:hover {
            border-color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
        }

        /* Ingredients Table Modal Styles */
        .modal-wide {
            max-width: 900px;
        }

        .table-container {
            overflow: auto;
            max-height: 70vh;
            border-radius: 8px;
            border: 1px solid #374151;
        }

        .ingredients-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .ingredients-table thead {
            position: sticky;
            top: 0;
            background: var(--card);
            z-index: 10;
        }

        .ingredients-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 2px solid #374151;
            white-space: nowrap;
        }

        .ingredients-table tbody tr {
            border-bottom: 1px solid #374151;
            transition: background-color 0.2s;
        }

        .ingredients-table tbody tr:hover {
            background: rgba(56, 189, 248, 0.05);
        }

        .ingredients-table td {
            padding: 12px 16px;
            color: var(--text);
            white-space: nowrap;
        }

        .ingredients-table td:first-child {
            font-weight: 500;
            color: var(--accent);
        }

        .ingredients-table tbody tr:last-child {
            border-bottom: none;
        }

        /* Removed malformed mobile media block */

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .mobile-header {
                display: flex;
                height: var(--mobile-header-h);
                min-height: var(--mobile-header-h);
                align-items: center;
            }

            .sidebar {
                position: fixed;
                top: var(--mobile-header-h);
                left: 0;
                height: calc(100dvh - var(--mobile-header-h));
                z-index: 1000;
                transform: translateX(-100%);
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar-overlay.visible {
                display: block;
            }

            .tooltip {
                position: fixed;
                top: 50%;
                left: 50%;
                right: auto;
                transform: translate(-50%, -50%);
                max-width: 90%;
                margin-top: 0;
            }

            .main {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                min-height: 0;
                position: relative;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                flex-shrink: 0;
                position: relative;
            }

            .brand {
                display: none;
            }

            .messages {
                padding: 12px 16px;
            }

            .bubble {
                max-width: 90%;
            }

            form {
                padding: 12px 16px;
            }

            textarea {
                font-size: 16px;
                min-height: 50px;
                max-height: 150px;
            }

            footer {
                padding: 6px 16px;
                flex-shrink: 0;
                flex-direction: column;
                gap: 4px;
                font-size: 11px;
            }

            .btn {
                padding: 10px 12px;
                font-size: 14px;
            }

            .chat-item {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="mobile-header">
        <button class="hamburger" id="menu-toggle">‚ò∞</button>
        <div class="mobile-brand">Nutrition Chat</div>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="brand">Nutrition Chat</div>
        <div class="user-profile" id="user-profile">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">üë§</div>
                <div class="user-details">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-email" id="user-email"></div>
                </div>
            </div>
            <button class="btn-logout" id="logout-btn" title="Logout">üö™</button>
        </div>
        <button class="btn" id="new-chat">+ New Meal</button>
        <div class="chat-list" id="chat-list"></div>
        <button class="btn-settings" id="settings-btn">‚öôÔ∏è Settings</button>
        <div class="ingredients-section">
            <div class="ingredients-header" id="ingredients-header">
                üìä Ingredient Data
                <div class="tooltip" id="ingredients-tooltip">
                    <div class="tooltip-content">
                        <strong>üìã CSV Format Instructions:</strong>
                        <ul>
                            <li><strong>Columns:</strong> name, calories, protein, fat, carbohydrates</li>
                            <li><strong>Values:</strong> Per gram nutritional data</li>
                            <li><strong>Example:</strong> chicken breast,1.65,0.31,0.036,0</li>
                        </ul>
                        <strong>üí° Usage:</strong>
                        Upload CSV to enable nutrition queries in chat. Download to export current data.
                    </div>
                </div>
            </div>
            <div class="ingredients-actions">
                <button class="btn-secondary" id="upload-btn">üì§ Upload CSV</button>
                <button class="btn-secondary" id="download-btn">üì• Download CSV</button>
                <button class="btn-secondary" id="view-table-btn">üìã View Table</button>
                <input type="file" id="file-input" accept=".csv" />
                <div class="ingredient-count" id="ingredient-count">Loading...</div>
            </div>
        </div>
    </aside>
    <main class="main">
        <div class="help-note">
            <button class="help-btn" id="help-btn" title="Help">‚ùì</button>
            <div class="tooltip" id="help-tooltip">
                <div class="tooltip-content">
                    Get a balanced set of ingredients to prep your meal. Type or read a list of ingredients and a list
                    of grams per ingredients based on your macro requirements will display. You can set you macro
                    requirements in Settings or type them in your chat message. In addition to the ingredients, also
                    mention the amount of calories you want the meal to have
                </div>
            </div>
        </div>
        <div class="messages" id="messages"></div>
        <form id="chat-form">
            <textarea id="input" placeholder="Ask something..." required></textarea>
            <button class="btn" type="submit">Send</button>
        </form>
        <footer>
            <span>ü§ñ Model: <strong id="model-name">Loading...</strong></span>
            <span>üåê API: <strong id="api-base">Loading...</strong></span>
        </footer>
    </main>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="modal-close" id="close-settings">√ó</button>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Macro Composition</div>
                <div class="settings-toggle">
                    <span class="toggle-label">Enable macro composition tracking</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="macro-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="macro-inputs" id="macro-inputs">
                    <div class="input-group">
                        <label class="input-label" for="protein-pct">Protein Percentage</label>
                        <input type="number" id="protein-pct" class="input-field" min="0" max="100"
                            placeholder="e.g., 30">
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="carbs-pct">Carbs Percentage</label>
                        <input type="number" id="carbs-pct" class="input-field" min="0" max="100"
                            placeholder="e.g., 40">
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="fat-pct">Fat Percentage</label>
                        <input type="number" id="fat-pct" class="input-field" min="0" max="100" placeholder="e.g., 30">
                    </div>

                    <div class="input-hint">All percentages must sum to 100%</div>
                </div>

                <div id="settings-error" class="error-message" style="display: none;"></div>
                <div id="settings-success" class="success-message" style="display: none;"></div>

                <button class="btn" id="save-settings" style="margin-top: 16px;">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Ingredients Table Modal -->
    <div class="modal-overlay" id="ingredients-table-modal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <div class="modal-title">Ingredients Data</div>
                <button class="modal-close" id="close-ingredients-table">√ó</button>
            </div>

            <div class="table-container">
                <table class="ingredients-table" id="ingredients-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Calories (per gram)</th>
                            <th>Protein (per gram)</th>
                            <th>Fat (per gram)</th>
                            <th>Carbs (per gram)</th>
                        </tr>
                    </thead>
                    <tbody id="ingredients-table-body">
                        <!-- Table rows will be inserted here -->
                    </tbody>
                </table>
                <div id="no-ingredients-message"
                    style="display: none; text-align: center; padding: 40px; color: var(--muted);">
                    No ingredients loaded. Upload a CSV file to get started.
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script>
        // ============================================================================
        // Authentication
        // ============================================================================

        function getToken() {
            return localStorage.getItem('token');
        }

        function isAuthenticated() {
            return !!getToken();
        }

        function redirectToLogin() {
            window.location.href = '/login.html';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('remember');
            redirectToLogin();
        }

        async function apiCall(url, options = {}) {
            const token = getToken();
            if (!token) {
                redirectToLogin();
                return;
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...(options.headers || {})
            };

            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });

                if (response.status === 401) {
                    // Token expired or invalid
                    logout();
                    return null;
                }

                return response;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        async function loadUserProfile() {
            try {
                const response = await apiCall('/api/auth/me');
                if (!response) return;

                const user = await response.json();

                const avatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');
                const userEmail = document.getElementById('user-email');

                if (user.username) {
                    avatar.textContent = user.username.charAt(0).toUpperCase();
                    userName.textContent = user.full_name || user.username;
                    userEmail.textContent = user.email;
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }

        // Check authentication on load
        if (!isAuthenticated()) {
            redirectToLogin();
        }

        // Logout button
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        });

        // Settings Modal
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettings = document.getElementById('close-settings');
        const macroEnabled = document.getElementById('macro-enabled');
        const macroInputs = document.getElementById('macro-inputs');
        const saveSettingsBtn = document.getElementById('save-settings');

        // Load and display current settings
        async function loadSettings() {
            try {
                const settings = await api('/api/settings');
                macroEnabled.checked = settings.macro_enabled;
                document.getElementById('protein-pct').value = settings.protein_pct || '';
                document.getElementById('carbs-pct').value = settings.carbs_pct || '';
                document.getElementById('fat-pct').value = settings.fat_pct || '';

                if (settings.macro_enabled) {
                    macroInputs.classList.add('active');
                }
            } catch (err) {
                console.error('Failed to load settings:', err);
            }
        }

        // Open settings modal
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
            loadSettings();
        });

        // Close settings modal
        closeSettings.addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });

        // Close modal when clicking overlay
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('active');
            }
        });

        // Toggle macro inputs visibility
        macroEnabled.addEventListener('change', () => {
            if (macroEnabled.checked) {
                macroInputs.classList.add('active');
            } else {
                macroInputs.classList.remove('active');
            }
        });

        // Save settings
        saveSettingsBtn.addEventListener('click', async () => {
            const errorEl = document.getElementById('settings-error');
            const successEl = document.getElementById('settings-success');
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            const settings = {
                macro_enabled: macroEnabled.checked
            };

            if (macroEnabled.checked) {
                const proteinPct = parseInt(document.getElementById('protein-pct').value);
                const carbsPct = parseInt(document.getElementById('carbs-pct').value);
                const fatPct = parseInt(document.getElementById('fat-pct').value);

                if (isNaN(proteinPct) || isNaN(carbsPct) || isNaN(fatPct)) {
                    errorEl.textContent = 'All percentage fields are required when macro composition is enabled';
                    errorEl.style.display = 'block';
                    return;
                }

                const total = proteinPct + carbsPct + fatPct;
                if (total !== 100) {
                    errorEl.textContent = `Percentages must sum to 100% (current: ${total}%)`;
                    errorEl.style.display = 'block';
                    return;
                }

                settings.protein_pct = proteinPct;
                settings.carbs_pct = carbsPct;
                settings.fat_pct = fatPct;
            }

            try {
                await api('/api/settings', {
                    method: 'PUT',
                    body: JSON.stringify(settings)
                });
                successEl.textContent = 'Settings saved successfully!';
                successEl.style.display = 'block';
                setTimeout(() => {
                    settingsModal.classList.remove('active');
                }, 1500);
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to save settings';
                errorEl.style.display = 'block';
            }
        });

        // ============================================================================
        // Application Logic
        // ============================================================================

        const chatList = document.getElementById('chat-list');
        const messagesEl = document.getElementById('messages');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('input');
        let currentChatId = null;

        // Mobile menu toggle
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('visible');
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', toggleSidebar);
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        // Tooltip for ingredients header
        const ingredientsHeader = document.getElementById('ingredients-header');
        const ingredientsTooltip = document.getElementById('ingredients-tooltip');
        let tooltipTimeout;

        if (ingredientsHeader && ingredientsTooltip) {
            // Desktop hover
            ingredientsHeader.addEventListener('mouseenter', () => {
                clearTimeout(tooltipTimeout);
                ingredientsTooltip.classList.add('show');
            });

            ingredientsHeader.addEventListener('mouseleave', () => {
                tooltipTimeout = setTimeout(() => {
                    ingredientsTooltip.classList.remove('show');
                }, 200);
            });

            // Mobile tap
            let tapTimer;
            ingredientsHeader.addEventListener('touchstart', (e) => {
                if (ingredientsTooltip.classList.contains('show')) {
                    ingredientsTooltip.classList.remove('show');
                } else {
                    e.preventDefault();
                    ingredientsTooltip.classList.add('show');
                    // Auto-hide after 5 seconds on mobile
                    clearTimeout(tapTimer);
                    tapTimer = setTimeout(() => {
                        ingredientsTooltip.classList.remove('show');
                    }, 5000);
                }
            });

            // Close tooltip when clicking outside
            document.addEventListener('click', (e) => {
                if (!ingredientsHeader.contains(e.target)) {
                    ingredientsTooltip.classList.remove('show');
                }
            });
        }

        // Close sidebar when selecting a chat on mobile
        function selectChatMobile(id) {
            currentChatId = id;
            loadMessages(id);
            loadChats(id);
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                document.getElementById('model-name').textContent = config.model;
                document.getElementById('api-base').textContent = config.api_base;
            } catch (err) {
                console.error('Failed to load config:', err);
            }
        }

        async function loadIngredientCount() {
            try {
                const response = await apiCall('/api/ingredients/count');
                if (!response) return;
                const data = await response.json();
                const countEl = document.getElementById('ingredient-count');
                countEl.textContent = data.count > 0 ? `${data.count} ingredients loaded` : 'No data loaded';
            } catch (err) {
                console.error('Failed to load ingredient count:', err);
                document.getElementById('ingredient-count').textContent = 'Error loading count';
            }
        }

        async function api(path, options = {}) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` }),
                ...(options.headers || {})
            };

            const res = await fetch(path, { ...options, headers });

            if (res.status === 401) {
                logout();
                return null;
            }

            if (!res.ok) throw new Error(await res.text());
            return res.headers.get('content-type')?.includes('json') ? res.json() : res.text();
        }

        function renderChats(chats) {
            chatList.innerHTML = '';
            chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
                const title = document.createElement('div');
                title.className = 'chat-title';
                title.textContent = chat.title;
                const actions = document.createElement('div');
                actions.className = 'chat-actions';
                const rename = document.createElement('button');
                rename.className = 'icon-btn';
                rename.textContent = '‚úèÔ∏è';
                rename.onclick = async (e) => {
                    e.stopPropagation();
                    const next = prompt('Rename chat', chat.title);
                    if (next && next.trim()) {
                        await api(`/api/chats/${chat.id}`, { method: 'PATCH', body: JSON.stringify({ title: next.trim() }) });
                        loadChats(chat.id);
                    }
                };
                const del = document.createElement('button');
                del.className = 'icon-btn danger';
                del.textContent = 'üóë';
                del.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm('Delete this chat?')) {
                        await api(`/api/chats/${chat.id}`, { method: 'DELETE' });
                        if (currentChatId === chat.id) currentChatId = null;
                        loadChats();
                        messagesEl.innerHTML = '';
                    }
                };
                actions.append(rename, del);
                item.append(title, actions);
                item.onclick = () => selectChatMobile(chat.id);
                chatList.appendChild(item);
            });
        }

        async function loadChats(selectId) {
            const chats = await api('/api/chats');
            if (selectId) currentChatId = selectId;
            if (!currentChatId && chats.length) currentChatId = chats[0].id;
            renderChats(chats);
            if (currentChatId) loadMessages(currentChatId);
        }

        async function selectChat(id) {
            currentChatId = id;
            await loadMessages(id);
            loadChats(id);
        }

        function renderMessages(messages) {
            messagesEl.innerHTML = '';
            messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = 'bubble ' + msg.role;

                if (msg.role === 'assistant') {
                    // Render markdown for assistant messages
                    const htmlContent = marked.parse(msg.content);
                    bubble.innerHTML = DOMPurify.sanitize(htmlContent);
                } else {
                    // Plain text for user messages
                    bubble.textContent = msg.content;
                }

                messagesEl.appendChild(bubble);
            });
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        async function loadMessages(id) {
            const messages = await api(`/api/chats/${id}/messages`);
            renderMessages(messages);
        }

        async function sendMessage(content) {
            if (!currentChatId) {
                const created = await api('/api/chats', { method: 'POST', body: JSON.stringify({}) });
                currentChatId = created.id;
                loadChats(currentChatId);
            }
            const payload = { content };
            const res = await api(`/api/chats/${currentChatId}/messages`, { method: 'POST', body: JSON.stringify(payload) });
            await loadMessages(currentChatId);
            return res;
        }

        document.getElementById('new-chat').onclick = async () => {
            const created = await api('/api/chats', { method: 'POST', body: JSON.stringify({}) });
            currentChatId = created.id;
            await loadChats(currentChatId);
            messagesEl.innerHTML = '';
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = input.value.trim();
            if (!content) return;
            input.value = '';

            // Show user message immediately
            const userBubble = document.createElement('div');
            userBubble.className = 'bubble user';
            userBubble.textContent = content;
            messagesEl.appendChild(userBubble);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            // Show loading indicator
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'bubble loading';
            const loadingText = document.createElement('span');
            loadingText.className = 'loading-dots';
            loadingText.textContent = 'Waiting for response';
            loadingBubble.appendChild(loadingText);
            messagesEl.appendChild(loadingBubble);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            try {
                // sendMessage calls loadMessages which re-renders all messages from API
                await sendMessage(content);
            } catch (err) {
                loadingBubble.remove();
                alert('Error sending message: ' + err.message);
            }
        });

        document.getElementById('upload-btn').onclick = () => {
            document.getElementById('file-input').click();
        };

        document.getElementById('file-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const token = getToken();
            if (!token) {
                redirectToLogin();
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/ingredients/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (res.status === 401) {
                    logout();
                    return;
                }

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                const result = await res.json();
                alert(`‚úÖ ${result.message}`);
                loadIngredientCount();
            } catch (err) {
                alert(`‚ùå Upload failed: ${err.message}`);
            }

            e.target.value = '';
        };

        // Help tooltip behavior
        const helpBtn = document.getElementById('help-btn');
        const helpTooltip = document.getElementById('help-tooltip');

        function showHelp() {
            helpTooltip.classList.add('show');
        }

        function hideHelp() {
            helpTooltip.classList.remove('show');
        }

        helpBtn.addEventListener('mouseenter', showHelp);
        helpBtn.addEventListener('mouseleave', hideHelp);
        helpBtn.addEventListener('click', () => {
            if (helpTooltip.classList.contains('show')) {
                hideHelp();
            } else {
                showHelp();
            }
        });

        // Hide help when clicking outside
        document.addEventListener('click', (e) => {
            if (!helpTooltip.contains(e.target) && e.target !== helpBtn) {
                hideHelp();
            }
        });

        document.getElementById('download-btn').onclick = async () => {
            const token = getToken();
            if (!token) {
                redirectToLogin();
                return;
            }

            try {
                const res = await fetch('/api/ingredients/download', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.status === 401) {
                    logout();
                    return;
                }

                if (!res.ok) throw new Error('Download failed');

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ingredients.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                alert(`‚ùå Download failed: ${err.message}`);
            }
        };

        // Ingredients Table Modal
        const ingredientsTableModal = document.getElementById('ingredients-table-modal');
        const viewTableBtn = document.getElementById('view-table-btn');
        const closeIngredientsTable = document.getElementById('close-ingredients-table');

        // Load and display ingredients in table
        async function loadIngredientsTable() {
            try {
                const ingredients = await api('/api/ingredients');
                const tableBody = document.getElementById('ingredients-table-body');
                const noIngredientsMsg = document.getElementById('no-ingredients-message');

                tableBody.innerHTML = '';

                if (!ingredients || ingredients.length === 0) {
                    noIngredientsMsg.style.display = 'block';
                    tableBody.parentElement.style.display = 'none';
                    return;
                }

                noIngredientsMsg.style.display = 'none';
                tableBody.parentElement.style.display = 'table';

                ingredients.forEach(ingredient => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ingredient.name}</td>
                        <td>${ingredient.calories_per_gram.toFixed(2)}</td>
                        <td>${ingredient.protein_per_gram.toFixed(2)}</td>
                        <td>${ingredient.fat_per_gram.toFixed(2)}</td>
                        <td>${ingredient.carbs_per_gram.toFixed(2)}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (err) {
                console.error('Failed to load ingredients:', err);
                alert('Failed to load ingredients table');
            }
        }

        // Open ingredients table modal
        viewTableBtn.addEventListener('click', () => {
            ingredientsTableModal.classList.add('active');
            loadIngredientsTable();
        });

        // Close ingredients table modal
        closeIngredientsTable.addEventListener('click', () => {
            ingredientsTableModal.classList.remove('active');
        });

        // Close modal when clicking overlay
        ingredientsTableModal.addEventListener('click', (e) => {
            if (e.target === ingredientsTableModal) {
                ingredientsTableModal.classList.remove('active');
            }
        });

        // Initialize app
        loadUserProfile();
        loadChats();
        loadConfig();
        loadIngredientCount();
    </script>
</body>

</html>